<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Edit Post</title>
  <link rel="stylesheet" href="/styles/upload.css" />
  <link rel="stylesheet" href="/styles/style.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha2/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />
</head>
<body>
  <div class="container py-4">
    <a href="javascript:history.back()" class="btn btn-outline-secondary btn-sm mb-3">‚Üê Back to Profile</a>
    <h2>Edit Post</h2>

    <form action="/posts/<%= post._id %>/edit" method="POST" enctype="multipart/form-data">
 
      <div class="mb-3">
        <label for="coverImage" class="form-label">Cover Image</label><br>
        <img src="<%= post.coverImage || (post.steps[0] && post.steps[0].image) || '/images/default.jpg' %>" alt="cover" style="max-width: 200px;" class="mb-2">
        <input type="file" name="coverImage" class="form-control" />
      </div>

      <div class="mb-3">
        <label for="title" class="form-label">Title</label>
        <input type="text" name="title" class="form-control" value="<%= post.title %>" required>
      </div>

      <div class="mb-3">
        <label for="description" class="form-label">Description</label>
        <textarea name="description" class="form-control" rows="4" required><%= post.description %></textarea>
      </div>

      <div class="mb-3">
        <label for="tags" class="form-label">Tags (comma separated)</label>
        <input type="text" name="tags" class="form-control" value="<%= post.tags.map(t => '#' + t).join(' ') %>">
      </div>

      <hr class="my-4">
      <h4 class="mb-3">Steps</h4>

      <div class="mb-3">
        <% post.steps.forEach((s, idx) => { %>
          <div class="card mb-3" data-step-card="<%= idx %>">
            <div class="card-body">
              <div class="d-flex gap-3 align-items-start">
                <div style="width:180px;">
                  <% if (s.type === 'image') { %>
                    <img src="<%= s.image %>" class="img-fluid rounded border" />
                  <% } else { %>
                    <video class="img-fluid rounded border" controls>
                      <source src="<%= s.video %>" type="video/mp4" />
                    </video>
                  <% } %>
                </div>
                <div class="flex-grow-1">
                  <label class="form-label">Description</label>
                  <textarea name="existingStepTexts[]" class="form-control" rows="2"><%= s.text || '' %></textarea>
                  <div class="form-text">Upload to replace this step media (optional)</div>
                  <input type="file" name="existingStepFile_<%= idx %>" accept="image/*,video/*" class="form-control" />
                  <input type="hidden" name="existingStepTypes[]" value="<%= s.type %>">
                  <input type="hidden" name="existingStepImage[]" value="<%= s.image || '' %>">
                  <input type="hidden" name="existingStepVideo[]" value="<%= s.video || '' %>">
                  <button type="button" class="btn btn-outline-danger btn-sm mt-2" data-del-step="<%= idx %>">Delete this step</button>
                </div>
              </div>
            </div>
          </div>
        <% }) %>
      </div>

      <div class="mb-3">
        <h5>Add New Steps</h5>
        <div id="newSteps"></div>
        <button type="button" id="addNewStepBtn" class="btn btn-outline-danger btn-sm mt-2">+ Add step</button>
      </div>

      <button type="submit" class="btn btn-primary btn-sm">Update Post</button>
    </form>
  </div>

  <script>
    const newSteps = document.getElementById('newSteps');
    const addBtn = document.getElementById('addNewStepBtn');
    addBtn?.addEventListener('click', () => {
      const wrapper = document.createElement('div');
      wrapper.className = 'card mb-3';
      wrapper.innerHTML = `
        <div class="card-body">
          <div class="mb-2"><strong>New step</strong></div>
          <input type="file" name="newStepFiles" accept="image/*,video/*" class="form-control mb-2" required />
          <textarea name="newStepTexts[]" class="form-control mb-2" rows="2" placeholder="Add description..."></textarea>
          <button type="button" class="btn btn-outline-danger btn-sm remove-new-step">Delete this step</button>
        </div>`;
      newSteps.appendChild(wrapper);
    });

    // delete existing step immediately
    document.addEventListener('click', (e) => {
      // remove existing
      const btn = e.target.closest('[data-del-step]');
      if (btn) {
        const idx = btn.getAttribute('data-del-step');
        const hidden = document.createElement('input');
        hidden.type = 'hidden';
        hidden.name = 'existingStepDelete[]';
        hidden.value = idx;
        btn.form.appendChild(hidden);
        const card = btn.closest('[data-step-card]');
        if (card) card.remove();
        return;
      }
      // remove newly added
      const rm = e.target.closest('.remove-new-step');
      if (rm) {
        const card = rm.closest('.card');
        if (card) card.remove();
      }
    });
  </script>
</body>
</html>
