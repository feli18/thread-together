<%
/** ğŸ” ç»Ÿè®¡åº”è¯¥è¢«æŠ˜å çš„å›å¤æ•°ï¼ˆåªæŠ˜å é¡¶æ¥¼è¯„è®ºä¸‹ç¬¬ 2 æ¡åŠå…¶åä»£ï¼‰ */
function countHiddenReplies(comment, level) {
  if (!comment.children || comment.children.length === 0) return 0;

  let count = 0;
  comment.children.forEach((child, index) => {
    if (level === 1 && index === 0) {
      // ç¬¬ä¸€æ¡å­è¯„è®ºä¸æŠ˜å 
      count += countHiddenReplies(child, level + 1);
    } else {
      // ç¬¬äºŒæ¡èµ·åŠå…¶åä»£æŠ˜å 
      count += 1 + countHiddenReplies(child, level + 1);
    }
  });

  return count;
}
%>

<div class="ps-<%= level * 4 %> mt-3 comment-block" data-level="<%= level %>" data-root="<%= rootId %>">
  <div class="d-flex justify-content-between align-items-start">
    <div class="d-flex">
      <img src="<%= comment.user.avatar || '/images/default-avatar.png' %>" class="rounded-circle me-2" style="width: 32px; height: 32px;" />
      <div>
        <p class="mb-1 fw-semibold"><%= comment.user.username %></p>
        <p class="mb-1"><%= comment.text %></p>
        <div class="text-muted small d-flex gap-3">
          <span><%= comment.createdAt.toLocaleDateString() %></span>
          <a href="#" class="reply-btn text-decoration-none" data-reply-id="<%= comment._id %>"><i class="bi bi-chat-left-text"></i> å›å¤</a>
        </div>

        <!-- éšè—å›å¤æ¡† -->
        <form action="/posts/<%= post._id %>/comments" method="POST" class="reply-form d-none mt-2" data-parent-id="<%= comment._id %>">
            <input type="hidden" name="replyTo" value="<%= comment._id %>" />
            <div class="input-group">
                <input type="text" name="comment" class="form-control form-control-sm" placeholder="å›å¤ <%= comment.user.username %>" required />
                <button type="submit" class="btn btn-sm btn-outline-primary">å‘é€</button>
            </div>
        </form>
      </div>
    </div>

    <% if (currentUser && comment.user._id.toString() === currentUser.toString()) { %>
      <div class="dropdown">
        <button class="btn btn-sm text-muted border-0" type="button" data-bs-toggle="dropdown">
          <i class="bi bi-three-dots-vertical"></i>
        </button>
        <ul class="dropdown-menu">
          <li>
            <form action="/posts/<%= post._id %>/comments/<%= comment._id %>?_method=DELETE" method="POST">
              <button type="submit" class="dropdown-item text-danger">åˆ é™¤</button>
            </form>
          </li>
        </ul>
      </div>
    <% } %>
  </div>

  <!-- å­è¯„è®ºé€’å½’æ¸²æŸ“ -->
<% if (comment.children && comment.children.length > 0) {
  const nextLevel = level + 1;
  comment.children.forEach((child, index) => {
    // å¦‚æœæ˜¯é¡¶æ¥¼çš„ç¬¬2ä¸ª child èµ·ï¼Œæˆ–è€…æ˜¯è¿™äº› child çš„å­å­™ï¼Œéƒ½åº”è¯¥æŠ˜å 
    const shouldCollapse = (index > 0 && level === 0) || rootId !== comment._id;
%>
  <div class="nested-comment <%= shouldCollapse ? 'd-none' : '' %>" data-root="<%= rootId %>">
    <%- include('../partials/commentItem', {
      comment: child,
      post: post,
      currentUser: currentUser,
      level: nextLevel,
      rootId: rootId  // ä¸å†æ”¹å˜ rootIdï¼Œæ°¸è¿œç”¨é¡¶æ¥¼é‚£ä¸€å±‚çš„ id
    }) %>
  </div>
<% }); %>


  <% if (level === 0) {
       const hiddenCount = countHiddenReplies(comment, 1);
       if (hiddenCount > 0) { %>
    <button class="btn btn-sm btn-link text-primary toggle-replies-btn px-0 mt-1"
            data-root-id="<%= comment._id %>">
      å±•å¼€ <%= hiddenCount %> æ¡å›å¤
    </button>
  <% }} %>
  <% } %>
</div>
